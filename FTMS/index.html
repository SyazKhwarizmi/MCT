<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FTMS Dashboard - Google Sheets</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 30px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .config-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .config-toggle {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }

        .config-toggle:hover {
            transform: translateY(-2px);
        }

        .config-content {
            display: none;
        }

        .config-content.active {
            display: block;
        }

        .sheet-config {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
        }

        .sheet-config h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1.2em;
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 600;
            font-size: 0.9em;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #667eea;
            font-weight: 600;
        }

        .error {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #c62828;
        }

        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .sheets-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .sheet-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .sheet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #ddd;
        }

        .sheet-title {
            font-size: 1.5em;
            font-weight: 600;
            color: #333;
        }

        .sheet-stats {
            display: flex;
            gap: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .sheet-stat {
            background: white;
            padding: 5px 10px;
            border-radius: 5px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9em;
            position: relative;
        }

        .filter-header {
            position: relative;
            padding: 12px;
        }

        .filter-header > div:first-child {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            gap: 8px;
        }

        .filter-icon {
            cursor: pointer;
            font-size: 1.1em;
            padding: 4px 6px;
            border-radius: 3px;
            transition: background-color 0.2s;
            flex-shrink: 0;
        }

        .filter-icon:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .filter-icon.active {
            background-color: rgba(255, 255, 255, 0.3);
        }

        .filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #667eea;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            margin-top: 5px;
        }

        .filter-dropdown.active {
            display: block;
        }

        .filter-content {
            padding: 10px;
        }

        .filter-search {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }

        .filter-options {
            max-height: 200px;
            overflow-y: auto;
        }

        .filter-option {
            display: flex;
            align-items: center;
            padding: 5px;
            cursor: pointer;
        }

        .filter-option:hover {
            background-color: #f0f0f0;
        }

        .filter-option input[type="checkbox"] {
            margin-right: 8px;
            cursor: pointer;
        }

        .filter-option label {
            cursor: pointer;
            flex: 1;
            font-size: 0.9em;
            color: #333;
        }

        .filter-actions {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }

        .filter-btn {
            flex: 1;
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85em;
            font-weight: 600;
            transition: all 0.2s;
        }

        .filter-btn-apply {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .filter-btn-apply:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(102, 126, 234, 0.3);
        }

        .filter-btn-clear {
            background: #f0f0f0;
            color: #666;
        }

        .filter-btn-clear:hover {
            background: #e0e0e0;
        }

        td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            font-size: 0.9em;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .link-cell {
            color: #667eea;
            text-decoration: none;
            word-break: break-all;
        }

        .link-cell:hover {
            text-decoration: underline;
        }

        .image-cell {
            text-align: center;
            padding: 10px;
        }

        .image-cell img {
            max-width: 200px;
            max-height: 200px;
            border-radius: 5px;
            cursor: pointer;
            object-fit: contain;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .image-cell img:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .image-cell iframe {
            max-width: 200px;
            max-height: 200px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .image-cell iframe:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .refresh-btn {
            background: #4caf50;
            margin-top: 10px;
        }

        .refresh-btn:hover {
            background: #45a049;
        }

        .nav-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            text-decoration: none;
            font-weight: 600;
            transition: transform 0.2s;
            display: inline-block;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
        }

        .nav-btn.active {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }
    </style>
    </head>
    <body>
    <!-- Load configuration file if available -->
    <script src="config.js" onerror="console.log('config.js not found, using localStorage instead')"></script>
    <div class="container">
        <div class="header">
            <h1>üèÜ FTMS Dashboard</h1>
            <p class="subtitle">Tournament Management System - Google Sheets Integration</p>
            <div class="nav-buttons">
                <a href="index.html" class="nav-btn active">üìä Dashboard</a>
                <a href="leaderboard.html" class="nav-btn">üêü Submissions</a>
                <a href="leaderboard-individual.html" class="nav-btn">üë§ Individual</a>
                <a href="leaderboard-team.html" class="nav-btn">üèÖ Team</a>
            </div>
            <button class="btn refresh-btn" id="refreshBtn" onclick="loadAllSheets()" style="display: none; max-width: 200px; margin: 20px auto 0;">
                üîÑ Refresh Data
            </button>
        </div>


        <div id="loading" class="loading" style="display: none;">
            Loading all sheets...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="dashboard" style="display: none;">
            <div class="dashboard-stats" id="dashboardStats"></div>
            <div class="sheets-container" id="sheetsContainer"></div>
        </div>
    </div>

    <script>
        // Helper function to get config value (checks CONFIG first, then localStorage)
        function getConfig(key) {
            if (typeof CONFIG !== 'undefined' && CONFIG[key]) {
                return CONFIG[key];
            }
            return localStorage.getItem(key) || '';
        }

        // Helper function to set config value (saves to localStorage)
        function setConfig(key, value) {
            localStorage.setItem(key, value);
        }

        let sheetsData = {
            Players: null,
            Team: null,
            Boat: null,
            submission_dev: null
        };


        async function loadAllSheets() {
            const loadingDiv = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const dashboard = document.getElementById('dashboard');

            errorDiv.style.display = 'none';
            dashboard.style.display = 'none';
            loadingDiv.style.display = 'block';

            // Get configuration from config.js or localStorage
            const apiKey = getConfig('apiKey');
            const sheetId = getConfig('sheetId');

            if (!apiKey || !sheetId) {
                loadingDiv.style.display = 'none';
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Please configure your API Key and Sheet ID in config.js file';
                return;
            }

            const sheetConfigs = {
                Players: getConfig('playersSheet') || 'Players',
                Team: getConfig('teamSheet') || 'Team',
                Boat: getConfig('boatSheet') || 'Boat',
                submission_dev: getConfig('submissionSheet') || 'submission'
            };

            const errors = [];
            const loadedSheets = {};

            // Load all sheets in parallel
            const loadPromises = Object.keys(sheetConfigs).map(async (sheetName) => {
                const sheetTabName = sheetConfigs[sheetName];
                if (!sheetTabName) {
                    errors.push(`${sheetName}: No sheet name provided`);
                    return;
                }

                try {
                    const data = await loadFromAPI(sheetId, sheetTabName, apiKey);
                    if (data && data.length > 0) {
                        loadedSheets[sheetName] = data;
                        sheetsData[sheetName] = data;
                    } else {
                        errors.push(`${sheetName}: No data found`);
                    }
                } catch (error) {
                    errors.push(`${sheetName}: ${error.message}`);
                }
            });

            await Promise.all(loadPromises);

            loadingDiv.style.display = 'none';

            if (errors.length > 0 && Object.keys(loadedSheets).length === 0) {
                errorDiv.style.display = 'block';
                errorDiv.innerHTML = '<strong>Errors:</strong><br>' + errors.join('<br>');
                return;
            }

            if (errors.length > 0) {
                errorDiv.style.display = 'block';
                errorDiv.innerHTML = '<strong>Some sheets failed to load:</strong><br>' + errors.join('<br>');
            }

            if (Object.keys(loadedSheets).length > 0) {
                displayDashboard(loadedSheets);
                dashboard.style.display = 'block';
                document.getElementById('refreshBtn').style.display = 'block';
            }
        }

        async function loadFromAPI(sheetId, sheetName, apiKey) {
            // Use the sheet name with a large range to get all data (up to 1000 rows and 26 columns)
            // If you need more, you can adjust the range or use multiple calls
            const range = `${sheetName}!A1:Z1000`;
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${encodeURIComponent(range)}?key=${apiKey}`;
            
            const response = await fetch(url);
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const errorMsg = errorData.error?.message || `API Error: ${response.status} ${response.statusText}`;
                throw new Error(errorMsg);
            }

            const data = await response.json();
            
            if (!data.values || data.values.length === 0) {
                throw new Error('No data found in the specified range');
            }

            return data.values;
        }

        function displayDashboard(loadedSheets) {
            const container = document.getElementById('sheetsContainer');
            const statsDiv = document.getElementById('dashboardStats');
            
            container.innerHTML = '';
            
            // Calculate overall statistics
            let totalRows = 0;
            let totalSheets = Object.keys(loadedSheets).length;
            
            Object.values(loadedSheets).forEach(sheet => {
                totalRows += sheet.length - 1; // Subtract header row
            });

            // Display overall stats
            statsDiv.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalSheets}</div>
                    <div class="stat-label">Active Sheets</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalRows}</div>
                    <div class="stat-label">Total Records</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${loadedSheets.Players ? loadedSheets.Players.length - 1 : 0}</div>
                    <div class="stat-label">Players</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${loadedSheets.Team ? loadedSheets.Team.length - 1 : 0}</div>
                    <div class="stat-label">Teams</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${loadedSheets.Boat ? loadedSheets.Boat.length - 1 : 0}</div>
                    <div class="stat-label">Boats</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${loadedSheets.submission_dev ? loadedSheets.submission_dev.length - 1 : 0}</div>
                    <div class="stat-label">Submissions</div>
                </div>
            `;

            // Create combined Players-Team-Boat table
            if (loadedSheets.Players && loadedSheets.Team && loadedSheets.Boat) {
                const combinedCard = createCombinedTable(loadedSheets.Players, loadedSheets.Team, loadedSheets.Boat);
                combinedCard.style.gridColumn = '1 / -1'; // Make it span full width
                container.appendChild(combinedCard);
            } else {
                // If not all three are available, show what we have
                if (loadedSheets.Players) {
                    const sheetCard = createSheetCard('Players', loadedSheets.Players);
                    container.appendChild(sheetCard);
                }
                if (loadedSheets.Team) {
                    const sheetCard = createSheetCard('Team', loadedSheets.Team);
                    container.appendChild(sheetCard);
                }
                if (loadedSheets.Boat) {
                    const sheetCard = createSheetCard('Boat', loadedSheets.Boat);
                    container.appendChild(sheetCard);
                }
            }
            
            // Display submission sheet separately below the list table
            if (loadedSheets.submission_dev) {
                const sheetCard = createSheetCard('submission_dev', loadedSheets.submission_dev);
                sheetCard.style.gridColumn = '1 / -1'; // Make it span full width and appear below
                container.appendChild(sheetCard);
            }
        }

        // Global filter functions for Excel-like column filtering
        function toggleFilterDropdown(columnIndex, icon) {
            // Close all other dropdowns
            document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
                if (dropdown.id !== `filter-${columnIndex}`) {
                    dropdown.classList.remove('active');
                }
            });
            
            document.querySelectorAll('.filter-icon').forEach(ic => {
                if (ic !== icon) {
                    ic.classList.remove('active');
                }
            });
            
            const dropdown = document.getElementById(`filter-${columnIndex}`);
            dropdown.classList.toggle('active');
            icon.classList.toggle('active');
        }

        function filterSearchOptions(columnIndex) {
            const searchInput = document.getElementById(`filter-search-${columnIndex}`);
            const searchTerm = searchInput.value.toLowerCase();
            const options = document.querySelectorAll(`#filter-options-${columnIndex} .filter-option`);
            
            options.forEach(option => {
                const label = option.querySelector('label').textContent.toLowerCase();
                option.style.display = label.includes(searchTerm) ? 'flex' : 'none';
            });
        }

        function updateFilter(columnIndex) {
            // This function can be used for real-time filtering if needed
        }

        function toggleSelectAll(columnIndex) {
            const selectAllCheckbox = document.getElementById(`select-all-${columnIndex}`);
            const checkboxes = document.querySelectorAll(`.filter-checkbox-${columnIndex}`);
            const isChecked = selectAllCheckbox.checked;
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
        }

        function updateSelectAllState(columnIndex) {
            const selectAllCheckbox = document.getElementById(`select-all-${columnIndex}`);
            const checkboxes = document.querySelectorAll(`.filter-checkbox-${columnIndex}`);
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            
            selectAllCheckbox.checked = allChecked;
        }

        function updateFilterOptions(filteredData) {
            const card = document.getElementById('combinedTable').closest('.sheet-card');
            if (!card) return;
            
            // Check if any filters are actually applied (not all items selected)
            let hasActiveFilters = false;
            document.querySelectorAll('.filter-dropdown').forEach((dropdown, idx) => {
                const allCheckboxes = dropdown.querySelectorAll('.filter-checkbox-' + idx);
                const checkedCheckboxes = dropdown.querySelectorAll('.filter-checkbox-' + idx + ':checked');
                if (allCheckboxes.length > 0 && checkedCheckboxes.length < allCheckboxes.length) {
                    hasActiveFilters = true;
                }
            });
            
            // Use filtered data if filters are active, otherwise use original data to show all options
            const dataToUse = hasActiveFilters ? filteredData : (card.originalData || []);
            if (!dataToUse || dataToUse.length === 0) return;
            
            // Get headers
            const headers = Array.from(document.querySelectorAll('#combinedTable thead th')).map(th => {
                const content = th.querySelector('div');
                return content ? content.textContent.trim() : '';
            });
            
            // Calculate unique values for each column from the data
            const columnUniqueValues = headers.map((_, colIndex) => {
                const values = new Set();
                dataToUse.forEach(row => {
                    const value = (row[colIndex] || '').toString().trim();
                    if (value) values.add(value);
                });
                return Array.from(values).sort();
            });
            
            // Update each filter dropdown
            headers.forEach((_, colIndex) => {
                const dropdown = document.getElementById(`filter-${colIndex}`);
                if (!dropdown) return;
                
                // Get currently selected values (before updating)
                const currentlySelected = Array.from(dropdown.querySelectorAll('.filter-checkbox-' + colIndex + ':checked'))
                    .map(cb => cb.value)
                    .filter(v => v);
                
                // Get the filter options container
                const optionsContainer = document.getElementById(`filter-options-${colIndex}`);
                if (!optionsContainer) return;
                
                // Store the "Select All" option HTML
                const selectAllOption = optionsContainer.querySelector('.select-all-option');
                const selectAllHTML = selectAllOption ? selectAllOption.outerHTML : '';
                
                // Clear and rebuild options
                optionsContainer.innerHTML = selectAllHTML;
                
                // Add updated filter options
                columnUniqueValues[colIndex].forEach(value => {
                    const safeId = `filter-${colIndex}-${value.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    const escapedValue = value.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                    const isChecked = currentlySelected.includes(value);
                    
                    const optionDiv = document.createElement('div');
                    optionDiv.className = 'filter-option';
                    optionDiv.innerHTML = `
                        <input type="checkbox" id="${safeId}" 
                               value="${escapedValue}" 
                               class="filter-checkbox-${colIndex}"
                               onchange="updateSelectAllState(${colIndex})" ${isChecked ? 'checked' : ''}>
                        <label for="${safeId}">${value}</label>
                    `;
                    optionsContainer.appendChild(optionDiv);
                });
                
                // Re-attach event listener to Select All
                const selectAllCheckbox = document.getElementById(`select-all-${colIndex}`);
                if (selectAllCheckbox) {
                    selectAllCheckbox.onchange = function() {
                        toggleSelectAll(colIndex);
                    };
                }
                
                // Update Select All state
                updateSelectAllState(colIndex);
            });
        }

        function applyFilter(columnIndex) {
            const card = document.getElementById('combinedTable').closest('.sheet-card');
            if (!card || !card.originalData) return;
            
            // Get all active filters
            const activeFilters = {};
            document.querySelectorAll('.filter-dropdown').forEach((dropdown, idx) => {
                // Exclude the "Select All" checkbox (it doesn't have a value attribute)
                const checked = Array.from(dropdown.querySelectorAll('input[type="checkbox"]:checked'))
                    .filter(cb => cb.value && cb.id !== `select-all-${idx}`)
                    .map(cb => cb.value);
                if (checked.length > 0) {
                    activeFilters[idx] = checked;
                }
            });
            
            // Get headers from the table
            const headers = Array.from(document.querySelectorAll('#combinedTable thead th')).map(th => {
                const content = th.querySelector('div');
                return content ? content.textContent.trim() : '';
            });
            
            // Filter data
            let filteredData = card.originalData.filter(row => {
                return headers.every((_, colIndex) => {
                    if (!activeFilters[colIndex]) return true; // No filter for this column
                    const cellValue = (row[colIndex] || '').toString().trim();
                    return activeFilters[colIndex].includes(cellValue);
                });
            });
            
            // Update table
            card.filteredData = filteredData;
            const tbody = document.getElementById('combinedTableBody');
            renderTableRows(filteredData, tbody);
            
            // Update row count
            const rowCountElement = document.getElementById('filteredRowCount');
            if (rowCountElement) {
                rowCountElement.textContent = `${filteredData.length} rows`;
            }
            
            // Update all filter dropdowns based on currently displayed data
            updateFilterOptions(filteredData);
            
            // Close dropdown
            const dropdown = document.getElementById(`filter-${columnIndex}`);
            dropdown.classList.remove('active');
            const icon = dropdown.previousElementSibling;
            if (icon) icon.classList.remove('active');
        }

        function clearFilter(columnIndex) {
            const dropdown = document.getElementById(`filter-${columnIndex}`);
            const checkboxes = dropdown.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
            applyFilter(columnIndex);
        }

        function renderTableRows(data, tbody) {
            tbody.innerHTML = '';
            data.forEach(row => {
                const tr = document.createElement('tr');
                row.forEach(cellValue => {
                    const td = document.createElement('td');
                    td.textContent = cellValue || '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function createCombinedTable(playersData, teamData, boatData) {
            const card = document.createElement('div');
            card.className = 'sheet-card';
            
            // Parse headers and rows for each table
            const playersHeaders = playersData[0].map(h => h.toLowerCase().replace(/\s+/g, '_'));
            const playersRows = playersData.slice(1);
            
            const teamHeaders = teamData[0].map(h => h.toLowerCase().replace(/\s+/g, '_'));
            const teamRows = teamData.slice(1);
            
            const boatHeaders = boatData[0].map(h => h.toLowerCase().replace(/\s+/g, '_'));
            const boatRows = boatData.slice(1);
            
            // Create lookup maps for Team and Boat
            const teamMap = {};
            teamRows.forEach(row => {
                const entry = {};
                teamHeaders.forEach((header, index) => {
                    entry[header] = row[index] || '';
                });
                const teamId = entry.teamid || entry.team_id || entry.id || '';
                if (teamId) {
                    teamMap[teamId] = entry;
                }
            });
            
            const boatMap = {};
            boatRows.forEach(row => {
                const entry = {};
                boatHeaders.forEach((header, index) => {
                    entry[header] = row[index] || '';
                });
                // Try multiple possible ID fields
                const boatId = entry.boatid || entry.boat_id || entry.id || entry.boat_id_number || '';
                const boatName = entry.boat_name || entry.name || entry.boatname || '';
                const teamId = entry.teamid || entry.team_id || '';
                // Create keys from boat ID, name, and team ID
                if (boatId) boatMap[boatId] = entry;
                if (boatName) boatMap[boatName] = entry;
                if (teamId) boatMap[`team_${teamId}`] = entry;
            });
            
            // Define the specific columns to show in order
            const combinedHeaders = [
                'Team Name',
                'Tag',
                'Name',
                'Gender',
                'Type',
                'Team Category',
                'Boat Id',
                'Boat Tekong'
            ];
            
            // Helper function to get value from entry by various possible column names
            function getValue(entry, possibleNames) {
                for (const name of possibleNames) {
                    if (entry[name] !== undefined && entry[name] !== '') {
                        return entry[name];
                    }
                }
                return '';
            }
            
            // Create combined rows
            const combinedRows = [];
            playersRows.forEach(playerRow => {
                const playerEntry = {};
                playersHeaders.forEach((header, index) => {
                    playerEntry[header] = playerRow[index] || '';
                });
                
                // Find matching team
                const teamId = playerEntry.team_id || playerEntry.teamid || '';
                const teamEntry = teamMap[teamId] || {};
                
                // Find matching boat - check multiple possible relationships
                let boatEntry = {};
                const playerBoatId = playerEntry.boat_id || playerEntry.boatid || '';
                const teamBoatId = teamEntry.boat_id || teamEntry.boatid || teamEntry.boat_name || teamEntry.boatname || '';
                const boatId = playerBoatId || teamBoatId;
                
                if (boatId && boatMap[boatId]) {
                    boatEntry = boatMap[boatId];
                } else if (teamId && boatMap[`team_${teamId}`]) {
                    boatEntry = boatMap[`team_${teamId}`];
                }
                
                // Create combined row with specific columns in order
                const combinedRow = [
                    // Team Name (from Team table, replacing team_id)
                    getValue(teamEntry, ['team_name', 'teamname', 'name', 'team_name_english']),
                    // Tag (from Players)
                    getValue(playerEntry, ['player_tag', 'tag', 'player_tag_number']),
                    // Name (from Players)
                    getValue(playerEntry, ['player_name', 'name', 'full_name', 'player_name_english']),
                    // Gender (from Players)
                    getValue(playerEntry, ['gender', 'Gender', 'sex']),
                    // Type (from Players)
                    getValue(playerEntry, ['type', 'Type', 'player_type']),
                    // Team Category (from Team)
                    getValue(teamEntry, ['category', 'category_name', 'type', 'cat', 'team_category']),
                    // Boat Id (from Boat)
                    getValue(boatEntry, ['boatid', 'boat_id', 'id', 'boat_id_number']),
                    // Boat Tekong (from Boat)
                    getValue(boatEntry, ['boat_tekong', 'tekong', 'boat_tekong_name', 'tekong_name', 'captain', 'boat_captain'])
                ];
                
                combinedRows.push(combinedRow);
            });
            
            // Create card header
            const header = document.createElement('div');
            header.className = 'sheet-header';
            header.innerHTML = `
                <div class="sheet-title">üë•List</div>
                <div class="sheet-stats">
                    <span class="sheet-stat" id="filteredRowCount">${combinedRows.length} rows</span>
                    <span class="sheet-stat">${combinedHeaders.length} columns</span>
                </div>
            `;
            
            const tableContainer = document.createElement('div');
            tableContainer.style.overflowX = 'auto';
            
            const table = document.createElement('table');
            table.id = 'combinedTable';
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            tbody.id = 'combinedTableBody';
            
            // Store original data for filtering
            const originalData = combinedRows.map(row => [...row]);
            
            // Get unique values for each column for filters
            const columnUniqueValues = combinedHeaders.map((_, colIndex) => {
                const values = new Set();
                combinedRows.forEach(row => {
                    const value = (row[colIndex] || '').toString().trim();
                    if (value) values.add(value);
                });
                return Array.from(values).sort();
            });
            
            // Header row with filters
            const headerRow = document.createElement('tr');
            combinedHeaders.forEach((headerText, colIndex) => {
                const th = document.createElement('th');
                th.className = 'filter-header';
                
                // Create a wrapper div for header content and icon
                const headerWrapper = document.createElement('div');
                headerWrapper.style.display = 'flex';
                headerWrapper.style.alignItems = 'center';
                headerWrapper.style.justifyContent = 'space-between';
                headerWrapper.style.width = '100%';
                
                const headerContent = document.createElement('span');
                headerContent.textContent = headerText;
                headerContent.style.flex = '1';
                headerContent.style.fontWeight = '600';
                
                const filterIcon = document.createElement('span');
                filterIcon.className = 'filter-icon';
                filterIcon.textContent = 'üîΩ';
                filterIcon.setAttribute('data-column', colIndex);
                filterIcon.style.cursor = 'pointer';
                filterIcon.onclick = function(e) {
                    e.stopPropagation();
                    toggleFilterDropdown(colIndex, filterIcon);
                };
                
                const filterDropdown = document.createElement('div');
                filterDropdown.className = 'filter-dropdown';
                filterDropdown.id = `filter-${colIndex}`;
                filterDropdown.innerHTML = createFilterContent(colIndex, columnUniqueValues[colIndex]);
                
                headerWrapper.appendChild(headerContent);
                headerWrapper.appendChild(filterIcon);
                th.appendChild(headerWrapper);
                th.appendChild(filterDropdown);
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // Data rows
            renderTableRows(combinedRows, tbody);
            
            table.appendChild(thead);
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            
            card.appendChild(header);
            card.appendChild(tableContainer);
            
            // Store original data in the card for filtering
            card.originalData = originalData;
            card.filteredData = combinedRows;
            
            return card;
        }

        function createFilterContent(columnIndex, uniqueValues) {
            let html = `
                <div class="filter-content">
                    <input type="text" class="filter-search" placeholder="Search..." id="filter-search-${columnIndex}" 
                           onkeyup="filterSearchOptions(${columnIndex})">
                    <div class="filter-options" id="filter-options-${columnIndex}">
                        <div class="filter-option select-all-option" style="border-bottom: 1px solid #ddd; padding-bottom: 8px; margin-bottom: 5px;">
                            <input type="checkbox" id="select-all-${columnIndex}" 
                                   onchange="toggleSelectAll(${columnIndex})" checked>
                            <label for="select-all-${columnIndex}" style="font-weight: 600;">Select All</label>
                        </div>
            `;
            
            uniqueValues.forEach(value => {
                // Create a safe ID by replacing special characters
                const safeId = `filter-${columnIndex}-${value.replace(/[^a-zA-Z0-9]/g, '_')}`;
                const escapedValue = value.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                html += `
                    <div class="filter-option">
                        <input type="checkbox" id="${safeId}" 
                               value="${escapedValue}" 
                               class="filter-checkbox-${columnIndex}"
                               onchange="updateSelectAllState(${columnIndex})" checked>
                        <label for="${safeId}">${value}</label>
                    </div>
                `;
            });
            
            html += `
                    </div>
                    <div class="filter-actions">
                        <button class="filter-btn filter-btn-apply" onclick="applyFilter(${columnIndex})">Apply</button>
                        <button class="filter-btn filter-btn-clear" onclick="clearFilter(${columnIndex})">Clear</button>
                    </div>
                </div>
            `;
            
            return html;
        }

        function createSheetCard(sheetName, data) {
            const card = document.createElement('div');
            card.className = 'sheet-card';
            
            const headers = data[0];
            const rows = data.slice(1);
            
            const header = document.createElement('div');
            header.className = 'sheet-header';
            const displayName = sheetName === 'submission_dev' ? 'Submission' : sheetName;
            header.innerHTML = `
                <div class="sheet-title">${getSheetIcon(sheetName)} ${displayName}</div>
                <div class="sheet-stats">
                    <span class="sheet-stat">${rows.length} rows</span>
                    <span class="sheet-stat">${headers.length} columns</span>
                </div>
            `;
            
            const tableContainer = document.createElement('div');
            tableContainer.style.overflowX = 'auto';
            
            const table = document.createElement('table');
            const thead = document.createElement('thead');
            const tbody = document.createElement('tbody');
            
            // Header row
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header || 'Column';
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            
            // Data rows
            rows.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach((_, index) => {
                    const td = document.createElement('td');
                    const cellValue = row[index] || '';
                    const columnName = (headers[index] || '').toLowerCase();
                    
                    // Check if it's a URL/link
                    if (cellValue.startsWith('http://') || cellValue.startsWith('https://')) {
                        // Check if it's an image URL (by URL pattern or column name)
                        if (isImageUrl(cellValue, columnName)) {
                            const imgContainer = document.createElement('div');
                            imgContainer.className = 'image-cell';
                            
                            const originalUrl = cellValue;
                            
                            // For Google Drive links, use iframe preview which is more reliable
                            if (originalUrl.includes('drive.google.com')) {
                                const fileId = extractGoogleDriveFileId(originalUrl);
                                if (fileId) {
                                    
                                    // Try to load as image first
                                    const img = document.createElement('img');
                                    const convertedUrl = `https://drive.google.com/uc?export=view&id=${fileId}`;
                                    img.src = convertedUrl;
                                    img.alt = 'Image';
                                    img.loading = 'lazy';
                                    
                                    img.onload = function() {
                                        // Image loaded successfully - make it clickable
                                        img.style.cursor = 'pointer';
                                        img.onclick = function() {
                                            window.open(originalUrl, '_blank');
                                        };
                                    };
                                    
                                    img.onerror = function() {
                                        // If image fails, use iframe preview
                                        img.style.display = 'none';
                                        const iframe = document.createElement('iframe');
                                        iframe.src = `https://drive.google.com/file/d/${fileId}/preview`;
                                        iframe.style.width = '200px';
                                        iframe.style.height = '200px';
                                        iframe.style.border = 'none';
                                        iframe.style.borderRadius = '5px';
                                        iframe.style.cursor = 'pointer';
                                        iframe.style.overflow = 'hidden';
                                        iframe.onclick = function() {
                                            window.open(originalUrl, '_blank');
                                        };
                                        imgContainer.appendChild(iframe);
                                    };
                                    
                                    imgContainer.appendChild(img);
                                } else {
                                    // Can't extract file ID, show as link
                                    const link = document.createElement('a');
                                    link.href = originalUrl;
                                    link.target = '_blank';
                                    link.className = 'link-cell';
                                    link.textContent = 'üì∑ View Image';
                                    imgContainer.appendChild(link);
                                }
                            } else {
                                // Not a Google Drive link - try regular image loading
                                const img = document.createElement('img');
                                img.src = convertToImageUrl(originalUrl);
                                img.alt = 'Image';
                                img.loading = 'lazy';
                                
                                img.onload = function() {
                                    img.style.cursor = 'pointer';
                                    img.onclick = function() {
                                        window.open(originalUrl, '_blank');
                                    };
                                };
                                
                                img.onerror = function() {
                                    img.style.display = 'none';
                                    const link = document.createElement('a');
                                    link.href = originalUrl;
                                    link.target = '_blank';
                                    link.className = 'link-cell';
                                    link.textContent = 'üì∑ View Image';
                                    imgContainer.appendChild(link);
                                };
                                
                                imgContainer.appendChild(img);
                            }
                            
                            td.appendChild(imgContainer);
                        } else {
                            // Regular URL - show as link
                            const link = document.createElement('a');
                            link.href = cellValue;
                            link.target = '_blank';
                            link.className = 'link-cell';
                            link.textContent = cellValue.length > 50 ? cellValue.substring(0, 50) + '...' : cellValue;
                            td.appendChild(link);
                        }
                    } else {
                        td.textContent = cellValue;
                    }
                    
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            
            table.appendChild(thead);
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            
            card.appendChild(header);
            card.appendChild(tableContainer);
            
            return card;
        }

        function getSheetIcon(sheetName) {
            const icons = {
                'Players': 'üë•',
                'Team': 'üèÖ',
                'Boat': 'üö§',
                'submission_dev': 'üìù',
                'submission': 'üìù'
            };
            return icons[sheetName] || 'üìä';
        }

        // Check if URL is an image URL
        function isImageUrl(url, columnName = '') {
            if (!url) return false;
            
            // Check column names that suggest images
            const imageKeywords = ['picture', 'image', 'img', 'photo', 'pic', 'thumbnail', 'fish_length_picture', 'picture_with_fish'];
            if (columnName && imageKeywords.some(keyword => columnName.includes(keyword))) {
                return true;
            }
            
            // Check for image file extensions
            const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.bmp', '.webp', '.svg'];
            const lowerUrl = url.toLowerCase();
            
            // Check if URL contains image extensions
            if (imageExtensions.some(ext => lowerUrl.includes(ext))) {
                return true;
            }
            
            // Check for Google Drive links (common for images)
            if (url.includes('drive.google.com') || url.includes('googleusercontent.com')) {
                return true;
            }
            
            // Check for common image hosting services
            if (url.includes('imgur.com') || url.includes('flickr.com') || 
                url.includes('photobucket.com') || url.includes('imageshack.us')) {
                return true;
            }
            
            return false;
        }

        // Extract Google Drive file ID from various URL formats
        function extractGoogleDriveFileId(url) {
            if (!url || !url.includes('drive.google.com')) return null;
            
            // Try multiple patterns to extract file ID
            let match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (match) return match[1];
            
            match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (match) return match[1];
            
            match = url.match(/[?&]id=([a-zA-Z0-9_-]+)/);
            if (match) return match[1];
            
            return null;
        }

        // Convert Google Drive link to direct image URL
        function convertToImageUrl(url) {
            if (!url) return url;
            
            const fileId = extractGoogleDriveFileId(url);
            if (fileId) {
                // Try direct view format (works if file is shared publicly)
                return `https://drive.google.com/uc?export=view&id=${fileId}`;
            }
            
            // Already a direct image URL or other format
            return url;
        }

        // Auto-load sheets on page load using config.js
        window.addEventListener('DOMContentLoaded', function() {
            // Get configuration from config.js or localStorage
            const apiKey = getConfig('apiKey');
            const sheetId = getConfig('sheetId');

            // Auto-load sheets if API key and Sheet ID are available
            if (apiKey && sheetId) {
                loadAllSheets();
            } else {
                const errorDiv = document.getElementById('error');
                errorDiv.style.display = 'block';
                errorDiv.textContent = 'Please configure your API Key and Sheet ID in config.js file';
            }
        });

        // Close filter dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.filter-header')) {
                document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
                    dropdown.classList.remove('active');
                });
                document.querySelectorAll('.filter-icon').forEach(icon => {
                    icon.classList.remove('active');
                });
            }
        });
    </script>
    </body>
</html>
